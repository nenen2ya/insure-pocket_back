# 
# =============================================
#  INSURE POCKET : ê°œì¸í™” ê¶Œì¥ ë³´ì¥ê¸ˆì•¡ ê³„ì‚°ê¸°
# =============================================
# ê¸°ëŠ¥ ìš”ì•½:
# - Supabaseì˜ users í…Œì´ë¸”ì—ì„œ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜´
# - ìœ„í—˜ë„ ë°ì´í„°(risk_df) ê¸°ë°˜ìœ¼ë¡œ ì¢…í•©ìœ„í—˜ë¹„ ê³„ì‚°
# - í‰ê·  ì¹˜ë£Œë¹„ì™€ ê³±í•´ì„œ ê¶Œì¥ ë³´ì¥ê¸ˆì•¡ ì‚°ì¶œ
# - ê²°ê³¼ë¥¼ pandas DataFrameìœ¼ë¡œ ì¶œë ¥
# =============================================

from db import supabase
import pandas as pd

# -------------------------------------------------------
# 1ï¸âƒ£ ìœ„í—˜ë¹„ ë°ì´í„° ì •ì˜
# -------------------------------------------------------
cancers = ["ê°„ì•”", "ì·Œì¥ì•”", "íì•”", "ìœ„ì•”", "ëŒ€ì¥ì•”", "ìœ ë°©ì•”", "ê°‘ìƒì„ ì•”"]

data = {
    "ì—°ë ¹": {
        "0-14": [0.007, 0.008, 0.005, 0.009, 0.008, 0.007, 0.006],
        "15-34": [0.048, 0.052, 0.036, 0.060, 0.052, 0.047, 0.042],
        "35-64": [0.272, 0.297, 0.203, 0.338, 0.297, 0.264, 0.235],
        "65ì´ìƒ": [0.785, 0.855, 0.584, 0.974, 0.855, 0.762, 0.678],
    },
    "ì„±ë³„": {
        "ì—¬": [0.088, 0.087, 0.068, 0.139, 0.074, 0.537, 0.597],
        "ë‚¨": [0.246, 0.095, 0.138, 0.275, 0.108, 0.003, 0.203],
    },
    "í¡ì—°": {
        "ë¹„í¡ì—°ì": [0.057, 0.103, 0.117, 0.070, 0.062, 0.028, 0.014],
        "í•˜ë£¨ 10ê°œë¹„ ì´í•˜": [0.193, 0.349, 0.398, 0.239, 0.210, 0.093, 0.046],
        "í•˜ë£¨ 10ê°œë¹„ ì´ˆê³¼": [0.252, 0.457, 0.520, 0.312, 0.274, 0.122, 0.060],
    },
    "ìŒì£¼": {
        "ì£¼ 0ë³‘": [0.218, 0.153, 0.100, 0.093, 0.254, 0.180, 0.034],
        "ì£¼ 1-3ë³‘": [0.262, 0.154, 0.102, 0.100, 0.257, 0.236, 0.034],
        "ì£¼ 4ë³‘ ì´ìƒ": [0.354, 0.239, 0.106, 0.115, 0.398, 0.394, 0.053],
    },
    "ì§ì—…êµ°": {
        "ì €ìœ„í—˜êµ°": [0.059, 0.065, 0.147, 0.073, 0.065, 0.058, 0.171],
        "ê³ ìœ„í—˜êµ°": [0.107, 0.117, 0.267, 0.133, 0.117, 0.104, 0.309],
    },
    "ìš´ì „": {
        "ë¹„ìš´ì „ì": [0.028, 0.030, 0.034, 0.034, 0.030, 0.027, 0.040],
        "ìš´ì „ì": [0.028, 0.030, 0.034, 0.034, 0.030, 0.027, 0.040],
    }
}

risk_df = {k: pd.DataFrame(v, index=cancers).T for k, v in data.items()}

# í‰ê·  ì¹˜ë£Œë¹„ (ë‹¨ìœ„: ë§Œì›)
treatment_costs = {
    "ê°„ì•”": 6623,
    "ì·Œì¥ì•”": 6372,
    "íì•”": 4657,
    "ìœ„ì•”": 2686,
    "ëŒ€ì¥ì•”": 2352,
    "ìœ ë°©ì•”": 1769,
    "ê°‘ìƒì„ ì•”": 1126
}

# -------------------------------------------------------
# 2ï¸âƒ£ Supabaseì—ì„œ user ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
# -------------------------------------------------------
def get_user_data(user_id: int):
    response = supabase.table("users").select(
        "age, gender, job, drinking, smoking, drive_license"
    ).eq("id", user_id).execute()

    if not response.data:
        raise ValueError(f"âŒ User ID {user_id} not found")

    return response.data[0]


# -------------------------------------------------------
# 3ï¸âƒ£ enum â†’ ìœ„í—˜í‘œ keyë¡œ ë§¤í•‘
# -------------------------------------------------------
mapping = {
    "gender": {"Male": "ë‚¨", "Female": "ì—¬"},
    "job": {"low": "ì €ìœ„í—˜êµ°", "high": "ê³ ìœ„í—˜êµ°"},
    "drinking": {
        "none": "ì£¼ 0ë³‘",
        "weekly_3": "ì£¼ 1-3ë³‘",
        "weekly_4_plus": "ì£¼ 4ë³‘ ì´ìƒ",
    },
    "smoking": {
        "none": "ë¹„í¡ì—°ì",
        "less_than_10": "í•˜ë£¨ 10ê°œë¹„ ì´í•˜",
        "more_than_10": "í•˜ë£¨ 10ê°œë¹„ ì´ˆê³¼",
    },
    "drive_license": {"YES": "ìš´ì „ì", "NO": "ë¹„ìš´ì „ì"},
}


# -------------------------------------------------------
# 4ï¸âƒ£ ìœ„í—˜ë¹„ ê³„ì‚° í•¨ìˆ˜
# -------------------------------------------------------
def calculate_recommendation(user_id: int):
    user_data = get_user_data(user_id)

    # ë‚˜ì´ëŒ€ ë¶„ë¥˜
    age = user_data["age"]
    if age < 15:
        age_group = "0-14"
    elif age < 35:
        age_group = "15-34"
    elif age < 65:
        age_group = "35-64"
    else:
        age_group = "65ì´ìƒ"

    # ì‚¬ìš©ì ì„ íƒê°’ ë§¤í•‘
    user_choice = {
        "ì—°ë ¹": age_group,
        "ì„±ë³„": mapping["gender"][user_data["gender"]],
        "í¡ì—°": mapping["smoking"][user_data["smoking"]],
        "ìŒì£¼": mapping["drinking"][user_data["drinking"]],
        "ì§ì—…êµ°": mapping["job"][user_data["job"]],
        "ìš´ì „": mapping["drive_license"][user_data["drive_license"]],
    }

    # ì¢…í•©ìœ„í—˜ë¹„ ê³„ì‚°
    total_risk = pd.Series(0, index=cancers)
    for category, choice in user_choice.items():
        total_risk += risk_df[category].loc[choice]

    # ê¶Œì¥ ë³´ì¥ê¸ˆì•¡ ê³„ì‚°
    recommend_amount = total_risk * pd.Series(treatment_costs)

    # ê²°ê³¼ DataFrame êµ¬ì„±
    result_df = pd.DataFrame({
        "ì¢…í•©ìœ„í—˜ë¹„": total_risk.round(3),
        "í‰ê· ì¹˜ë£Œë¹„(ë§Œì›)": pd.Series(treatment_costs),
        "ê¶Œì¥ë³´ì¥ê¸ˆì•¡(ë§Œì›)": recommend_amount.round(1)
    })

    return user_choice, result_df


# -------------------------------------------------------
# 5ï¸âƒ£ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸)
# -------------------------------------------------------
if __name__ == "__main__":
    user_id = 6  # ì˜ˆì‹œ
    user_choice, result_df = calculate_recommendation(user_id)

    print("âœ… ì‚¬ìš©ì ì •ë³´:")
    print(user_choice)
    print("\nğŸ§® [ì¢…í•©ìœ„í—˜ë¹„ ë° ê¶Œì¥ë³´ì¥ê¸ˆì•¡]")
    print(result_df)
